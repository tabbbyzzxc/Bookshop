@model CartListViewModel
<section class="pt-5 pb-5">
    <div class="container">
        <div class="row w-100">
            <div class="col-lg-12 col-md-12 col-12">
                <h3 class="display-5 mb-2 text-center">Shopping Cart</h3>
                <p class="mb-5 text-center">
                    <i class="text-info font-weight-bold">@Model.CartLines.Sum(x => x.Quantity)</i> items in your cart
                </p>
                <table id="shoppingCart" class="table table-condensed table-responsive">
                    <thead>
                        <tr>
                            <th style="width:60%">Product</th>
                            <th style="width:12%">Price</th>
                            <th style="width:10%">Quantity</th>
                            <th style="width:16%"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var cartLine in Model.CartLines)
                        {
                            <tr id="@cartLine.FrontId">
                                <td data-th="Books">
                                    <div class="row">
                                        <div class="col-md-3 text-left">
                                            <img src="/pudge.png" alt="" class="img-fluid d-none d-md-block rounded mb-2 shadow ">
                                        </div>
                                        <div class="col-md-9 text-left mt-sm-2">
                                            <h4>@cartLine.Book.Title</h4>
                                            <p class="font-weight-light">@cartLine.Book.Author</p>
                                        </div>
                                    </div>
                                </td>
                                <td id="@cartLine.FrontId" data-th="Price">₴@cartLine.Total</td>
                                <td data-th="Quantity">
                                    <input onchange="updateCartLine(@cartLine.Id, this.value, @cartLine.Book.BuyPrice, '@cartLine.FrontId')" type="number" class="form-control form-control-lg text-center" value="@cartLine.Quantity">
                                </td>
                                <td class="actions" data-th="">
                                    <div class="text-right">
                                        <button onclick="removeCartLine(@cartLine.Id, '@cartLine.FrontId')" class="btn btn-white border-secondary bg-white btn-md mb-2">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="float-right text-right">
                    <h4>Subtotal:</h4>
                    <h1 id="totalHeader">₴@Model.Total</h1>
                </div>
            </div>
        </div>
        <div class="row mt-4 d-flex align-items-center">
            <div class="col-sm-6 order-md-2 text-right">
                <a asp-controller="Orders" asp-action="Order" class="btn btn-primary mb-4 btn-lg pl-5 pr-5">Checkout</a>
            </div>
            <div class="col-sm-6 mb-3 mb-m-1 order-md-1 text-md-left">
                <a asp-controller="Orders" asp-action="Index">
                    <i class="fas fa-arrow-left mr-2"></i> Continue Shopping
                </a>
            </div>
        </div>
    </div>
</section>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="successToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fa-solid fa-circle-exclamation rounded me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Book was successfully added to cart
        </div>
    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="failToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fa-solid fa-triangle-exclamation rounded me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Something went wrong!
        </div>
    </div>
</div>

<script src="https://kit.fontawesome.com/1961c270d9.js" crossorigin="anonymous"></script>
<script>
    function updateCartLine(bookId, quantity, price, elementId) {
        const formData = {
            bookId,
            quantity
        };

        var elementPrice = document.getElementById(elementId)
        var priceTotal = document.getElementById('totalHeader')

        elementPrice.innerHTML = price * quantity;

        $.ajax({
            type: 'POST',
            url: '/carts/update',
            data: formData,
            success: function (response) {
                if (response.response === true)
                    showToastSuccess(response.message);
                else
                    showToastFail(response.message);
            },
            error: function (error) {
                console.error('Error:', error);
                showToastFail();
            }
        });
    }

    function removeCartLine(Id, FrontId) {
        const formData = {
            Id
        }

        $.ajax({
            type: 'POST',
            url: '/carts/delete',
            data: formData,
            success: function (response) {
                if (response.response === true) {
                    showToastSuccess(response.message);
                    var liItem = document.getElementById(FrontId);
                    liItem.remove();
                } else {
                    showToastFail(response.message);
                }
            },
            error: function (error) {
                console.error('Error:', error);
                showToastFail();
            }
        });

    }

    function showToastSuccess(message) {
        var t = document.getElementById("successToast");
        var toast = new bootstrap.Toast(t);
        t.querySelector(".toast-body").innerHTML = message;
        toast.show();
    }

    function showToastFail(message) {
        var t = document.getElementById("failToast");
        var toast = new bootstrap.Toast(t);
        t.querySelector(".toast-body").innerHTML = message;
        toast.show();
    }
</script>
